'use strict';

var advanceDataTables = {
  init: function init(ajax, columns) {

    this.bindUIActions(ajax, columns);
  },
  bindUIActions: function bindUIActions(ajax, columns) {

    this.table = this.handleDataTables(ajax, columns);
    this.handleGlobalSearch();
    this.handleColumnSearch();
    this.handleSelecter();
    this.handleClearSelected();

    this.addFilterRow();
    this.removeFilterRow();
    this.clearFilter();

    this.table.buttons().container().appendTo('#dt-buttons').unwrap();
  },
  handleDataTables: function handleDataTables(ajax, columns) {
    return $('#myTable').DataTable({
      dom: '<\'text-muted\'Bi>\n        <\'table-responsive\'tr>\n        <\'mt-4\'p>',
      buttons: ['copyHtml5', { extend: 'print', autoPrint: false }],
      language: {
        paginate: {
          previous: '<i class="fa fa-lg fa-angle-left"></i>',
          next: '<i class="fa fa-lg fa-angle-right"></i>'
        }
      },
      autoWidth: false,
      ajax: ajax,
      deferRender: true,
      order: [1, 'asc'],
      columns: columns,
      headerCallback: function( thead, data, start, end, display ) {
          $(thead).find('th').eq(0).html('<div class="thead-dd dropdown"><span class="custom-control custom-control-nolabel custom-checkbox"><input type="checkbox" class="custom-control-input" id="check-handle"><label class="custom-control-label" for="check-handle"></label></span><div class="thead-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></div><div class="dropdown-arrow"></div><div class="dropdown-menu"><a class="dropdown-item" href="#">Select all</a><a class="dropdown-item" href="#">Unselect all</a><div class="dropdown-divider"></div><a class="dropdown-item" href="#">Bulk remove</a><a class="dropdown-item" href="#">Bulk edit</a><a class="dropdown-item" href="#">Separate actions</a></div></div>');
      },
      columnDefs: [{
          targets: 0,
          render: function render(data, type, row, meta) {
            return '<div class="custom-control custom-control-nolabel custom-checkbox">\n<input type="checkbox" class="custom-control-input" name="selectedRow[]" id="p' + row.id + '" value="' + row.id + '">\n<label class="custom-control-label" for="p' + row.id + '"></label>\n</div>';
          }
        }, {
          targets: columns.length - 1,
          render: function render(data, type, row, meta) {
            return '<a class="btn btn-sm btn-secondary"><i class="fa fa-pencil-alt"></i></a>\n<a class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#modalDelete"><i class="far fa-trash-alt"></i></a>';
          }
        }]
    });
  },
  handleGlobalSearch: function handleGlobalSearch() {
    var self = this;

    $('#table-search').on('keyup focus', function (e) {
      var value = $('#table-search').val();

      if (value.length && e.type === 'keyup') {
        self.clearSelectedRows();
      }

      self.table.search(value).draw();
    });
  },
  handleColumnSearch: function handleColumnSearch() {
    var self = this;

    $(document).on('keyup change', '.filter-control', function (e) {
      var filterRow = $(this).parents('.form-row');
      var column = filterRow.find('.filter-column').val();
      var value = filterRow.find('.filter-value').val();
      var operator = value === '' ? 'contain' : filterRow.find('.filter-operator').val();
      var pattern = value;
      var exp = '';

      if (operator === 'notcontain') {
        pattern = '^((?!' + value + ').)*$';
      } else if (operator === 'equal') {
        pattern = '^' + value + '$';
      } else if (operator === 'notequal') {
        pattern = '^(?!' + value + ').*$';
      } else if (operator === 'beginwith') {
        pattern = '^(' + value + '| ' + value + ').*';
      } else if (operator === 'endwith') {
        pattern = '.*' + value + '$';
      } else if (operator === 'greaterthan') {
        var arr = value.split('');

        $.each(arr, function (i, val) {
          exp += '[' + val + '-9]';
        });

        pattern = '^' + exp + '*$';
        console.log(pattern);
      } else if (operator === 'lessthan') {
        (function () {
          var arr = value.split('');
          var lastIndex = arr.length - 1;

          var _loop = function _loop(x) {
            exp += x > 0 ? '|' : '';

            $.each(arr, function (i, val) {
              if (i <= x && x === lastIndex) {
                exp += '[0-' + val + ']';
              }if (i <= x && x < lastIndex) {
                exp += '[0-9]';
              }
            });
          };

          for (var x = 0; x < arr.length; x++) {
            _loop(x);
          }

          pattern = '^(' + exp + ')$';
        })();
      }

      if (e.type === 'change' && $(e.target).is('select')) {
        filterRow.find('.filter-value').val('').trigger('keyup');
      }

      self.table.column(column).search(pattern, true, true).draw();
    });
  },
  addFilterRow: function addFilterRow() {
    $('#add-filter-row').on('click', function () {
      var rowTmpl = $('#filter-columns').children().first().clone();

      rowTmpl.find('select').prop('selectedIndex', 0);
      rowTmpl.find('input').val('');

      $('#filter-columns').append(rowTmpl);
    });
  },
  removeFilterRow: function removeFilterRow() {
    var self = this;
    $(document).on('click', '.remove-filter-row', function () {
      var $row = $(this).parents('.filter-row');
      $row.find('.filter-value').val('').trigger('keyup');
      if (self.isRemovableRow()) {
        $row.remove();
      }
    });
  },
  isRemovableRow: function isRemovableRow() {
    return $('#filter-columns').children().length > 1;
  },
  clearFilter: function clearFilter() {
    var self = this;

    $(document).on('click', '#clear-filter', function () {
      $('#modalFilterColumns').modal('hide');

      $('#filter-columns').find('select').prop('selectedIndex', 0);
      $('#filter-columns').find('input').val('');

      self.table.columns().search('').draw();
    });
  },
  handleSelecter: function handleSelecter() {
    var self = this;

    $(document).on('change', '#check-handle', function () {
      var isChecked = $(this).prop('checked');
      $('input[name="selectedRow[]"]').prop('checked', isChecked);

      self.getSelectedInfo();
    }).on('change', 'input[name="selectedRow[]"]', function () {
      var $selectors = $('input[name="selectedRow[]"]');
      var $selectedRow = $('input[name="selectedRow[]"]:checked').length;
      var prop = $selectedRow === $selectors.length ? 'checked' : 'indeterminate';

      $('#check-handle').prop('indeterminate', false).prop('checked', false);

      if ($selectedRow) {
        $('#check-handle').prop(prop, true);
      }

      self.getSelectedInfo();
    });
  },
  handleClearSelected: function handleClearSelected() {
    var self = this;
    $('#myTable').on('page.dt', function () {
      self.clearSelectedRows();
    });
    $('#clear-search').on('click', function () {
      self.clearSelectedRows();
    });
  },
  getSelectedInfo: function getSelectedInfo() {
    var $selectedRow = $('input[name="selectedRow[]"]:checked').length;
    var $info = $('.thead-btn');
    var $badge = $('<span/>').addClass('selected-row-info text-muted pl-1').text($selectedRow + ' selected');
    $('.selected-row-info').remove();
    if ($selectedRow) {
      $info.prepend($badge);
    }
  },
  clearSelectedRows: function clearSelectedRows() {
    $('#check-handle').prop('indeterminate', false).prop('checked', false).trigger('change');
  }
};